id: 07c85687-6dee-4266-9345-1e34de85d989
name: Email containing malware sent by an internal sender
description: |
  In this query, we looking for emails containing malware attachment sent by an internal sender
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
   - EmailEvents
tactics:
- Malware
query: |
  EmailEvents
  | where EmailDirection == "Intra-org" or EmailDirection == "Outbound"
  | where ThreatTypes == "Malware" and SenderFromAddress !startswith "postmaster@" and SenderFromAddress !startswith "microsoftexchange"
  | join (EmailAttachmentInfo | where isnotempty(ThreatTypes)) on NetworkMessageId