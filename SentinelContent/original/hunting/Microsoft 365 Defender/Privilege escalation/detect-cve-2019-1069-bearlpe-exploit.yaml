id: d82cdd92-4818-4f55-9e14-68021c154cdb
name: detect-cve-2019-1069-bearlpe-exploit
description: |
  This query was originally published in the threat analytics report, May 2019 0-day disclosures.
  In May and June of 2019, a security researcher with the online alias, SandboxEscaper, discovered and published several elevation-of-privilege vulnerabilities on Github. The researcher included proofs-of-concept demonstrating how to exploit these vulnerabilities.
  Patches and more information about each vulnerability are available below:
  1. CVE-2019-0863 | Windows Error Reporting Elevation of Privilege Vulnerability
  2. CVE-2019-1069 | Task Scheduler Elevation of Privilege Vulnerability
  3. CVE-2019-1053 | Windows Shell Elevation of Privilege Vulnerability
  4. CVE-2019-1064 | Windows Elevation of Privilege Vulnerability
  5. CVE-2019-0973 | Windows Installer Elevation of Privilege Vulnerability
  6. CVE-2019-1129 | Windows Elevation of Privilege Vulnerability
  This query locates possible activity that exploits CVE-2019-1069 (also known as BearLPE), the second vulnerability listed above.
  Reference - https://threatpost.com/sandboxescaper-more-exploits-ie-zero-day/145010/
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
  - DeviceFileEvents
tactics:
- Privilege escalation
query: |
  //Find possible use of BearLPE (Task Scheduler exploit)
  DeviceFileEvents
  | where FileName =~ "schtasks.exe"
  | where InitiatingProcessCommandLine contains "/change"
  and InitiatingProcessCommandLine contains " /TN "
  and InitiatingProcessCommandLine contains " /RU "
  and InitiatingProcessCommandLine contains " /RP "
  and InitiatingProcessCommandLine !contains " /S "
  and InitiatingProcessCommandLine !contains " /ST "
  and InitiatingProcessCommandLine !contains " /SD "
  and InitiatingProcessIntegrityLevel !in ("", "High", "System")
